gas-stripe-controller
=====================

Stripe の支払い・請求・セッションなどの情報を、Google Apps Script（GAS）を使って取得し、スプレッドシートなどに出力するためのスクリプト群です。

## 概要

このプロジェクトは、Stripe API から各種決済情報を取得し、Google スプレッドシートに自動的に出力するための GAS スクリプトです。各関数は最新のデータのみを取得し、既存のデータと重複しないように管理します。

## 各ファイルの処理内容

### `getStripeInfo.js`
- **機能**: Stripe API から情報を取得する共通関数
- **処理内容**:
  - スクリプトプロパティから Stripe のシークレットキー（`SECRET_KEY`）を取得
  - Bearer トークン認証で Stripe API にリクエストを送信
  - レスポンスを JSON 形式で返却

### `outputChargeInfo.js`
- **機能**: Stripe の取引情報（Charges）をスプレッドシートに出力
- **処理内容**:
  - Stripe API から取引情報（最大200件）と顧客情報（最大100件）を取得
  - 「取引情報」シートの B2 セルの日付以降の新しい取引のみを抽出
  - 各取引について、商品名を `payment_intent` または `invoice` から取得
  - 出力項目: ID、作成日時、顧客名、商品名、説明文、金額、決済方法、ステータス
  - 新しいデータをシートの2行目に挿入
  - エラー発生時は Slack に通知

### `outputInvoiceInfo.js`
- **機能**: Stripe の請求書情報（Invoices）をスプレッドシートに出力
- **処理内容**:
  - Stripe API から請求書情報（最大200件）を取得
  - 「請求書情報」シートの B2 セルの日付以降の新しい請求書のみを抽出
  - 支払い済み（`paid=true`）の請求書のみを対象
  - 出力項目: ID、請求日、顧客名、説明文、金額、ステータス
  - 新しいデータをシートの2行目に挿入
  - エラー発生時は Slack に通知

### `outputPaymentInfo.js`
- **機能**: Stripe の支払い情報（Payment Intents）をスプレッドシートに出力
- **処理内容**:
  - Stripe API から支払い情報（最大100件）を取得
  - 「支払い情報」シートの B2 セルの日付以降の新しい支払いのみを抽出
  - 出力項目: ID、作成日時、顧客名、説明文、金額、ステータス
  - 新しいデータをシートの2行目に挿入

### `outputSessionInfo.js`
- **機能**: Stripe のセッション情報（Checkout Sessions）をスプレッドシートに出力
- **処理内容**:
  - Stripe API からセッション情報を取得
  - 各セッションの `line_items` を取得して商品情報を取得
  - 「セッション情報」シートの B2 セルの日付以降の新しいセッションのみを抽出
  - 出力項目: ID、作成日時、顧客ID、案件名、金額
  - 新しいデータをシートの2行目に挿入

## セットアップ手順

### 1. 必要な準備

#### 1.1 Stripe API キーの取得
1. [Stripe Dashboard](https://dashboard.stripe.com/) にログイン
2. 開発者モードで「API キー」を開く
3. 「シークレットキー」をコピー（`sk_test_...` または `sk_live_...`）

#### 1.2 Google スプレッドシートの準備
以下のシート名でスプレッドシートを作成してください：
- `取引情報`
- `請求書情報`
- `支払い情報`
- `セッション情報`

各シートの2行目（B2セル）に最新の日付を設定してください。この日付以降のデータのみが取得されます。

#### 1.3 GAS プロジェクトの作成
1. 上記のスプレッドシートを開く
2. 「拡張機能」→「Apps Script」を選択
3. このリポジトリのファイルをコピー＆ペースト

### 2. 設定

#### 2.1 Stripe API キーの設定
1. GAS エディタで「プロジェクトの設定」（歯車アイコン）を開く
2. 「スクリプト プロパティ」セクションで「スクリプト プロパティを追加」をクリック
3. プロパティ名: `SECRET_KEY`、値: Stripe のシークレットキーを入力
4. 「保存」をクリック

#### 2.2 Slack 通知ライブラリの設定（エラー通知用）
- ライブラリ ID: `1BvEmX_MX8K_M5cx6wRAsIe1eN5lBHqzsI4xKchO5eGzSqF_AJaoOeIe3`
- `appsscript.json` に既に設定済みです
- 開発モードで使用する場合は、ライブラリの最新バージョンに更新してください

### 3. 実行方法

各関数を手動で実行するか、トリガーを設定して自動実行できます。

#### 手動実行
1. GAS エディタで関数名を選択
2. 「実行」ボタンをクリック
3. 初回実行時は権限の承認が必要です

#### 自動実行（トリガー設定）
1. GAS エディタで「トリガー」（時計アイコン）を開く
2. 「トリガーを追加」をクリック
3. 実行する関数、イベントのソース（時間主導型）、時間ベースのトリガーのタイプ（例: 1時間ごと）を設定
4. 「保存」をクリック

## 注意事項

- Stripe API のレート制限に注意してください（デフォルトでは1秒あたり100リクエスト）
- 各関数は最新のデータのみを取得するため、初回実行時は B2 セルに古い日付を設定することを推奨します
- `outputPaymentInfo.js` では顧客情報の取得処理が不完全な可能性があります（要確認）
- エラー通知には SlackNotification ライブラリが必要です
